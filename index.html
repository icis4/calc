<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neumorphic Glass Calculator</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: rgba(20, 24, 31, 0.55);
      --card-strong: rgba(20, 24, 31, 0.75);
      --text: #e8f0ff;
      --muted: #9fb0c7;
      --accent: #6ca8ff;
      --accent-2: #00d4ff;
      --danger: #ff5c7a;
      --warning: #ffd369;
      --shadow-1: rgba(0, 0, 0, 0.55);
      --shadow-2: rgba(255, 255, 255, 0.08);
      --radius: 16px;
      --ring: 0 0 0 1.25px rgba(108, 168, 255, 0.35), 0 0 0 10px rgba(108, 168, 255, 0.06);
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 15% -10%, #16212f 0%, var(--bg) 45%),
                  radial-gradient(1200px 600px at 85% 110%, #14273b 0%, var(--bg) 50%),
                  linear-gradient(180deg, #0a0e13, #0b0f14);
      color: var(--text);
      display: grid;
      place-items: center;
      padding: 0;
    }

    .app {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .log-panel { display: none; }
    .show-log .log-panel { display: block; }

    .log-panel {
      width: min(92vw, 320px);
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 25px 60px var(--shadow-1), inset 0 1px 0 var(--shadow-2);
      backdrop-filter: blur(18px) saturate(135%);
      -webkit-backdrop-filter: blur(18px) saturate(135%);
      overflow: hidden;
    }

    .log-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.2px;
    }

    .log-actions {
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .log-btn {
      appearance: none;
      -webkit-appearance: none;
      border: none;
      border-radius: 999px;
      padding: 7px 10px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--muted);
      cursor: pointer;
      box-shadow: inset 0 1px 0 var(--shadow-2);
      transition: 140ms ease;
      font: inherit;
      font-size: 12px;
      line-height: 1;
    }

    .log-btn:hover { transform: translateY(-1px); color: var(--text); }

    .log-list {
      padding: 12px;
      display: grid;
      gap: 10px;
      max-height: 520px;
      overflow: auto;
    }

    .log-item {
      border-radius: calc(var(--radius) - 10px);
      background: var(--card-strong);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: inset 0 1px 0 var(--shadow-2);
      padding: 10px 12px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: default;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .log-item-action {
      color: var(--muted);
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      min-width: 0;
      flex: 1 1 auto;
    }

    .log-item-value {
      color: var(--text);
      font-weight: 700;
      text-align: right;
      flex: 0 0 auto;
      max-width: 60%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .log-hint {
      padding: 0 12px 12px;
      color: var(--muted);
      font-size: 12px;
      text-align: center;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 50;
    }

    .show-help .modal { display: flex; }

    .modal-card {
      width: min(94vw, 820px);
      max-height: min(86vh, 720px);
      overflow: hidden;
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 25px 60px var(--shadow-1), inset 0 1px 0 var(--shadow-2);
      backdrop-filter: blur(18px) saturate(135%);
      -webkit-backdrop-filter: blur(18px) saturate(135%);
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    }

    .modal-title {
      color: var(--muted);
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .modal-close {
      appearance: none;
      -webkit-appearance: none;
      border: none;
      border-radius: 999px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--muted);
      cursor: pointer;
      box-shadow: inset 0 1px 0 var(--shadow-2);
      transition: 140ms ease;
    }

    .modal-close:hover { transform: translateY(-1px); color: var(--text); }

    .modal-body {
      padding: 14px 16px 16px;
      overflow: auto;
      color: var(--text);
      font-size: 14px;
      line-height: 1.45;
    }

    .modal-body h1,
    .modal-body h2,
    .modal-body h3 {
      margin: 12px 0 8px;
      color: var(--text);
    }

    .modal-body h1 { font-size: 18px; }
    .modal-body h2 { font-size: 16px; }
    .modal-body h3 { font-size: 15px; }

    .modal-body p { margin: 8px 0; color: var(--text); }
    .modal-body ul { margin: 8px 0 8px 18px; padding: 0; }
    .modal-body li { margin: 4px 0; color: var(--text); }
    .modal-body code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95em;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 1px 6px;
      border-radius: 999px;
      color: var(--text);
    }
    .modal-body pre {
      margin: 10px 0;
      padding: 12px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: calc(var(--radius) - 10px);
      overflow: auto;
    }
    .modal-body pre code {
      background: transparent;
      border: none;
      padding: 0;
      border-radius: 0;
      white-space: pre;
    }
    .modal-body a { color: var(--accent); text-decoration: none; }
    .modal-body a:hover { text-decoration: underline; }

    .shell {
      width: min(92vw, 460px);
      border-radius: var(--radius);
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 25px 60px var(--shadow-1), inset 0 1px 0 var(--shadow-2);
      backdrop-filter: blur(18px) saturate(135%);
      -webkit-backdrop-filter: blur(18px) saturate(135%);
      overflow: hidden;
    }

    .chrome {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    }
    .chrome-actions {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .brand {
      display: flex; gap: 8px; align-items: center;
      color: var(--muted);
      font-weight: 600; letter-spacing: 0.2px;
    }
    .pill {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--muted);
      box-shadow: inset 0 1px 0 var(--shadow-2);
      cursor: pointer; user-select: none;
      transition: 140ms ease;
    }
    .pill:hover { transform: translateY(-1px); color: var(--text); }

    .display {
      padding: 18px 18px 8px;
      display: grid; gap: 6px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    }
    .line-top {
      min-height: 22px;
      color: var(--muted);
      font-size: clamp(12px, 2.6vw, 14px);
      letter-spacing: 0.3px;
      text-align: right;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .line-bottom {
      min-height: 48px;
      font-weight: 700;
      font-size: clamp(26px, 9vw, 36px);
      text-align: right;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .pad {
      padding: 14px;
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(4, 1fr);
      align-items: stretch;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.03));
    }

    .row-advanced {
      display: none;
      grid-column: 1 / -1;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .show-sci .row-advanced { display: grid; }

    .row-std-extras {
      display: grid;
      grid-column: 1 / -1;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .show-sci .row-std-extras { display: none; }

    .row-std-vat {
      display: grid;
      grid-column: 1 / -1;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .show-sci .row-std-vat { display: none; }

    button.key {
      appearance: none; -webkit-appearance: none;
      border: none;
      border-radius: calc(var(--radius) - 8px);
      color: var(--text);
      background: var(--card-strong);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: 8px 12px 28px var(--shadow-1),
                  inset -2px -2px 8px rgba(0,0,0,0.35),
                  inset 1px 1px 1px rgba(255,255,255,0.08);
      padding: 16px 14px;
      font-size: clamp(16px, 4.6vw, 20px);
      font-weight: 600;
      letter-spacing: 0.2px;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease, color 120ms ease;
      position: relative;
      user-select: none;
    }
    button.key:hover { transform: translateY(-1.5px); }
    button.key:active { transform: translateY(0px) scale(0.98); }
    button.key.op { color: #cfe1ff; background: rgba(72, 110, 177, 0.34); }
    button.key.accent { color: #e8fbff; background: linear-gradient(180deg, rgba(108,168,255,0.35), rgba(0,212,255,0.28)); box-shadow: 0 0 0 2px rgba(108,168,255,0.35), 0 18px 40px rgba(0,212,255,0.18), inset 1px 1px 1px rgba(255,255,255,0.12); }
    button.key.danger { color: #ffeaf0; background: rgba(255, 92, 122, 0.28); }
    button.key.warning { color: #fff7e8; background: rgba(255, 211, 105, 0.28); }

    .key[data-wide="2"] { grid-column: span 2; }

    .footer {
      padding: 10px 14px 16px;
      color: var(--muted);
      font-size: 12px;
      text-align: center;
    }

    @media (max-width: 380px) {
      .pad { gap: 10px; }
      button.key { padding: 14px 12px; }
    }

    @media (max-width: 860px) {
      .app { flex-direction: column; align-items: center; }
      .log-panel { width: min(92vw, 460px); }
      .log-list { max-height: 240px; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <main class="shell" id="calc">
      <div class="chrome">
      <div class="chrome-actions">
        <div class="pill" id="toggleHelp" tabindex="0" role="button" aria-pressed="false" aria-label="Open help">Help</div>
        <div class="pill" id="toggleLog" tabindex="0" role="button" aria-pressed="false" aria-label="Show/hide log panel">LOG</div>
        <div class="pill" id="toggleAngle" tabindex="0" role="button" aria-pressed="false" aria-label="Toggle angle mode">DEG</div>
        <div class="pill" id="toggleSci" tabindex="0" role="button" aria-pressed="false" aria-label="Toggle calculator mode (STD/TRZ/SCI)">STD</div>
      </div>
    </div>

    <section class="display">
      <div class="line-top" id="lineTop" aria-live="polite" aria-atomic="true"></div>
      <div class="line-bottom" id="lineBottom" aria-live="polite" aria-atomic="true">0</div>
    </section>

    <section class="pad" id="pad">
      <!-- Advanced row (hidden by default, shown when Sci Mode active) -->
      <div class="row-advanced">
        <button class="key op" data-action="sqrt" aria-label="Square root">√</button>
        <button class="key op" data-action="power" aria-label="Exponent">x^y</button>
        <button class="key op" data-action="percent" aria-label="Percent">%</button>
        <button class="key op" data-action="sin" aria-label="Sine (degrees)">sin</button>
        <button class="key op" data-action="cos" aria-label="Cosine (degrees)">cos</button>
        <button class="key op" data-action="tan" aria-label="Tangent (degrees)">tan</button>
        <button class="key op" data-action="pi" aria-label="Pi">π</button>
        <button class="key op" data-action="inv" aria-label="Toggle inverse trig">INV</button>
        <button class="key op" data-action="ln" aria-label="Natural logarithm">ln</button>
        <button class="key op" data-action="log" aria-label="Base-10 logarithm">log</button>
        <button class="key op" data-action="expmark" aria-label="Scientific notation (e)">EXP</button>
        <button class="key op" data-action="negate" aria-label="Toggle sign">+/-</button>
        <button class="key op" data-action="coin" aria-label="Coin flip (0 or 1)">Coin</button>
        <button class="key op" data-action="dice" aria-label="Dice roll (1 to 6)">Dice</button>
        <button class="key op" data-action="rand" aria-label="Random number (0 to 1)">Rand</button>
      </div>

      <!-- Standard-only VAT helpers (hidden when Sci Mode active) -->
      <div class="row-std-vat">
        <button class="key op" data-action="vat-add" aria-label="Add VAT (20%)">+VAT</button>
        <button class="key op" data-action="vat-sub" aria-label="Remove VAT (20%)">-VAT</button>
        <button class="key op" data-action="round-2" aria-label="Round to 2 decimals">00</button>
        <button class="key op" data-action="round-3" aria-label="Round to 3 decimals">000</button>
      </div>

      <!-- Standard-only quick functions (hidden when Sci Mode active) -->
      <div class="row-std-extras">
        <button class="key op" data-action="eur" aria-label="Convert BGN to EUR">EUR</button>
        <button class="key op" data-action="bgn" aria-label="Convert EUR to BGN">BGN</button>
        <button class="key op" data-action="percent" aria-label="Percent">%</button>
        <button class="key op" data-action="negate" aria-label="Toggle sign">+/-</button>
      </div>

      <!-- Primary keys -->
      <button class="key danger" data-action="clear" aria-label="Clear">C</button>
      <button class="key warning" data-action="del" aria-label="Delete">DEL</button>
      <button class="key op" data-action="power-inline" aria-label="Exponent inline">^</button>
      <button class="key op" data-op="/" aria-label="Divide">÷</button>

      <button class="key" data-digit="7">7</button>
      <button class="key" data-digit="8">8</button>
      <button class="key" data-digit="9">9</button>
      <button class="key op" data-op="*" aria-label="Multiply">×</button>

      <button class="key" data-digit="4">4</button>
      <button class="key" data-digit="5">5</button>
      <button class="key" data-digit="6">6</button>
      <button class="key op" data-op="-" aria-label="Subtract">−</button>

      <button class="key" data-digit="1">1</button>
      <button class="key" data-digit="2">2</button>
      <button class="key" data-digit="3">3</button>
      <button class="key op" data-op="+" aria-label="Add">+</button>

      <button class="key" data-digit="0">0</button>
      <button class="key" data-dot="." aria-label="Decimal">.</button>
      <button class="key accent" data-wide="2" data-action="equals" aria-label="Equals">=</button>
    </section>

      <div class="footer" id="footerHelp">Keyboard: 0-9 . + - * / ^  Enter=Equals, Esc=Clear, Backspace=Delete, %=Percent</div>
    </main>

    <aside class="log-panel" aria-label="Log panel">
      <div class="log-header">
        <div>Log</div>
        <div class="log-actions">
          <button class="log-btn" id="logExport" type="button" aria-label="Export log to CSV">Export CSV</button>
          <button class="log-btn" id="logClear" type="button" aria-label="Clear log">Clear</button>
        </div>
      </div>
      <div class="log-list" id="logList" aria-live="polite" aria-atomic="false"></div>
      <div class="log-hint">Double-click an item to copy to display</div>
    </aside>
  </div>

  <div class="modal" id="helpModal" role="dialog" aria-modal="true" aria-label="Help" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-header">
        <div class="modal-title">Help</div>
        <button class="modal-close" id="helpClose" type="button" aria-label="Close help">Close</button>
      </div>
      <div class="modal-body" id="helpBody">Loading…</div>
    </div>
  </div>

  <script>
    // Calculator engine: state-driven like physical calculators
    // State variables hold previous value, current typed value, and the pending operator.
    const lineTop = document.getElementById('lineTop');
    const lineBottom = document.getElementById('lineBottom');
    const app = document.getElementById('app');
    const pad = document.getElementById('pad');
    const shell = document.getElementById('calc');
    const toggleHelp = document.getElementById('toggleHelp');
    const toggleLog = document.getElementById('toggleLog');
    const toggleSci = document.getElementById('toggleSci');
    const toggleAngle = document.getElementById('toggleAngle');
    const footerHelp = document.getElementById('footerHelp');
    const logList = document.getElementById('logList');
    const logExport = document.getElementById('logExport');
    const logClear = document.getElementById('logClear');
    const helpModal = document.getElementById('helpModal');
    const helpBody = document.getElementById('helpBody');
    const helpClose = document.getElementById('helpClose');

    let prev = null;       // previous numeric value (left operand)
    let current = '0';     // current input (string for easy editing)
    let operator = null;   // pending operator: '+', '-', '*', '/', '^'
    let overwrite = true;  // whether next digit should overwrite current
    let angleMode = 'DEG'; // trig angle mode: 'DEG' or 'RAD'
    let trigInverse = false; // when true: sin/cos/tan become arcsin/arccos/arctan
    let calcMode = 'STD';  // 'STD' | 'SCI' | 'TRZ' (TRZ duplicates STD)

    const LOG_STORAGE_KEY = 'calc_log_entries';
    const LOG_MAX_ENTRIES = 50;
    const logEntries = []; // array of { action: string, value: string }

    function saveLogEntries() {
      try {
        // Use localStorage (more capacity than cookies) for log persistence.
        const payload = logEntries.slice(0, LOG_MAX_ENTRIES).map((e) => ({
          action: String(e?.action ?? ''),
          value: String(e?.value ?? ''),
        }));
        localStorage.setItem(LOG_STORAGE_KEY, JSON.stringify(payload));
      } catch {
        // Ignore storage failures (private mode, quota, disabled storage).
      }
    }

    function loadLogEntries() {
      try {
        const raw = localStorage.getItem(LOG_STORAGE_KEY);
        if (!raw) return;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return;
        logEntries.length = 0;
        for (const item of parsed.slice(0, LOG_MAX_ENTRIES)) {
          // Backward compatibility: older versions stored strings.
          if (typeof item === 'string' || typeof item === 'number') {
            logEntries.push({ action: '', value: String(item) });
            continue;
          }
          if (item && typeof item === 'object') {
            const action = String(item.action ?? '');
            const value = String(item.value ?? item.v ?? '');
            if (value) logEntries.push({ action, value });
          }
        }
        renderLog();
      } catch {
        // Ignore malformed or unavailable storage.
      }
    }

    function appendLogValue(valueText, actionText = '') {
      const value = String(valueText ?? '');
      const action = String(actionText ?? '');
      if (!value || value === 'Error') return;
      logEntries.unshift({ action, value });
      // Keep the log bounded.
      if (logEntries.length > LOG_MAX_ENTRIES) logEntries.length = LOG_MAX_ENTRIES;
      renderLog();
      saveLogEntries();
    }

    function renderLog() {
      if (!logList) return;
      logList.innerHTML = '';
      for (const entry of logEntries) {
        const div = document.createElement('div');
        div.className = 'log-item';
        const actionEl = document.createElement('span');
        actionEl.className = 'log-item-action';
        actionEl.textContent = entry.action ? entry.action : '';

        const valueEl = document.createElement('span');
        valueEl.className = 'log-item-value';
        valueEl.textContent = formatForDisplay(entry.value);

        div.appendChild(actionEl);
        div.appendChild(valueEl);
        div.setAttribute('data-value', entry.value);
        logList.appendChild(div);
      }
    }

    function copyLogValueToDisplay(valueText) {
      const s = String(valueText ?? '');
      if (!s || s === 'Error') return;
      prev = null;
      operator = null;
      overwrite = true;
      lineTop.textContent = '';
      setCurrent(s);
    }

    function clearLog() {
      logEntries.length = 0;
      renderLog();
      saveLogEntries();
    }

    function csvEscape(value) {
      const s = String(value ?? '');
      // Quote fields that contain a quote, comma, or newline.
      if (/[",\r\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }

    function exportLogCsv() {
      const rows = [];
      rows.push(['Action', 'Value'].map(csvEscape).join(','));
      for (const entry of logEntries) {
        rows.push([csvEscape(entry.action), csvEscape(entry.value)].join(','));
      }

      const csv = rows.join('\r\n') + '\r\n';
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'calc-log.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 0);
    }

    // Cookie helpers (simple persistence for last-used modes)
    function setCookie(name, value, days = 365) {
      const maxAge = Math.floor(days * 24 * 60 * 60);
      document.cookie = `${encodeURIComponent(name)}=${encodeURIComponent(value)}; Max-Age=${maxAge}; Path=/; SameSite=Lax`;
    }

    function getCookie(name) {
      const target = `${encodeURIComponent(name)}=`;
      const parts = document.cookie ? document.cookie.split('; ') : [];
      for (const part of parts) {
        if (part.startsWith(target)) {
          return decodeURIComponent(part.slice(target.length));
        }
      }
      return null;
    }

    // Utilities
    const MAX_DISPLAY_LEN = 18;

    const fmt = (n) => {
      // format numeric output with limited precision, but keep typed decimals
      if (typeof n === 'string') return n;
      if (!isFinite(n)) return 'Error';
      const v = Number(n);
      // Normalize -0 to 0
      const normalized = Object.is(v, -0) ? 0 : v;
      // Use a reasonable precision for calculator results.
      // (Display compaction is handled separately by formatForDisplay.)
      const s = normalized.toPrecision(15);
      // Trim trailing zeros for non-exponential formats.
      if (!/[eE]/.test(s)) {
        return s.replace(/\.0+$/, '').replace(/(\.[0-9]*?)0+$/, '$1');
      }
      return s.replace('e+', 'e');
    };

    function formatForDisplay(text) {
      // Keep in-progress inputs readable (don't rewrite partial tokens).
      if (text == null) return '0';
      if (text === 'Error') return 'Error';

      const s = String(text);
      if (s.length <= MAX_DISPLAY_LEN) return s;

      const lower = s.toLowerCase();
      // Avoid altering incomplete scientific notation entry.
      if (lower.endsWith('e') || lower.endsWith('e-') || lower.endsWith('e+')) return s;
      if (s === '-' || s.endsWith('.')) return s;

      const n = Number(s);
      if (!isFinite(n)) return 'Error';

      // Create a compact exponential representation sized to MAX_DISPLAY_LEN.
      // Example: 8.1300813e3
      const expRaw = n.toExponential();
      const expPart = expRaw.slice(expRaw.toLowerCase().indexOf('e'));
      const expLen = expPart.replace('e+', 'e').length;
      const maxMantissaTotal = Math.max(1, MAX_DISPLAY_LEN - expLen);

      // Mantissa is like "d.dddd" or "d".
      // If we include a decimal point, we need at least 2 chars ("d.").
      const fracDigits = Math.max(0, maxMantissaTotal - 2);
      const compact = n.toExponential(fracDigits).replace('e+', 'e');
      if (compact.length <= MAX_DISPLAY_LEN) return compact;

      // Fallback: fewer digits.
      return n.toExponential(Math.max(0, fracDigits - 2)).replace('e+', 'e');
    }

    const symbolFor = (op) => ({ '+': '+', '-': '−', '*': '×', '/': '÷', '^': '^' }[op] || '');

    function renderTop() {
      const opSym = symbolFor(operator);
      const left = prev != null ? formatForDisplay(fmt(prev)) : '';
      const right = current != null ? formatForDisplay(current) : '';
      lineTop.textContent = operator ? `${left} ${opSym} ${right}` : left || '';
    }
    function renderBottom() {
      lineBottom.textContent = formatForDisplay(current ?? '0');
    }

    function setCurrent(val) {
      current = val;
      renderBottom();
      renderTop();
    }

    function clearAll() {
      prev = null; operator = null; overwrite = true; setCurrent('0'); lineTop.textContent = '';
    }

    function deleteBack() {
      if (overwrite) { setCurrent('0'); return; }
      if (current === 'Error') { setCurrent('0'); return; }
      if (current.length <= 1 || (current.length === 2 && current.startsWith('-'))) {
        setCurrent('0'); return;
      }
      setCurrent(current.slice(0, -1));
    }

    function inputDigit(d) {
      if (overwrite || current === '0') {
        current = d;
        overwrite = false;
      } else {
        current += d;
      }
      renderBottom(); renderTop();
    }

    function inputDot() {
      if (overwrite) {
        current = '0.'; overwrite = false; renderBottom(); renderTop(); return;
      }
      if (current === '-') {
        current = '-0.';
        overwrite = false;
        renderBottom();
        renderTop();
        return;
      }
      if (!current.includes('.')) {
        current += '.';
      }
      renderBottom(); renderTop();
    }

    function inputLeadingMinus() {
      // Allow typing a negative number naturally (e.g., "-5" or "5 * -3").
      // Only triggers when we're at the start of an entry.
      if (current === 'Error') { setCurrent('0'); }
      if (overwrite || current === '0') {
        current = '-';
        overwrite = false;
        renderBottom();
        renderTop();
        return true;
      }
      return false;
    }

    function maybeInputExpSign(sign) {
      // When entering scientific notation, allow +/- to apply to the exponent
      // instead of acting as an operator.
      // Valid forms we build: 5e3, 5e-4, 5e+7
      const idx = current.toLowerCase().indexOf('e');
      if (idx === -1) return false;
      const expPart = current.slice(idx + 1);
      if (expPart === '') {
        current += sign;
        overwrite = false;
        renderBottom(); renderTop();
        return true;
      }
      if (expPart === '-' && sign === '+') {
        current = current.slice(0, idx + 1);
        overwrite = false;
        renderBottom(); renderTop();
        return true;
      }
      if (expPart === '+' && sign === '-') {
        current = current.slice(0, idx + 1) + '-';
        overwrite = false;
        renderBottom(); renderTop();
        return true;
      }
      return false;
    }

    function inputExpMarker() {
      // Adds an exponent marker so users can enter 10e3 or 5.6e-4.
      // JS Number() can parse this format directly.
      if (current === 'Error') { setCurrent('0'); }
      if (current.toLowerCase().includes('e')) { return; }

      if (overwrite) {
        current = '1e';
        overwrite = false;
      } else {
        current += 'e';
      }
      renderBottom();
      renderTop();
    }

    function setOperator(op) {
      if (current === 'Error') { return; }
      const curNum = Number(current);
      if (prev == null) {
        prev = curNum; operator = op; overwrite = true;
      } else if (operator && !overwrite) {
        // chain operations: compute previous op with current, then set new operator
        const r = compute(prev, curNum, operator);
        prev = r; operator = op; current = fmt(r); overwrite = true;
      } else {
        operator = op; overwrite = true;
      }
      renderBottom(); renderTop();
    }

    function equals() {
      if (current === 'Error') { return; }
      if (operator == null || prev == null) { return; }
      const curNum = Number(current);
      const r = compute(prev, curNum, operator);
      const expr = `${fmt(prev)} ${symbolFor(operator)} ${fmt(curNum)}`;
      prev = null; operator = null; current = fmt(r); overwrite = true;
      lineTop.textContent = expr; renderBottom();
      appendLogValue(current, expr);
    }

    function applySqrt() {
      if (current === 'Error') { return; }
      const curNum = Number(current);
      if (curNum < 0) { setCurrent('Error'); return; }
      const r = Math.sqrt(curNum);
      current = fmt(r); overwrite = true; renderBottom(); renderTop();
      appendLogValue(current, `√ ${fmt(curNum)}`);
    }

    function applyLn() {
      // Natural log (ln). Domain: x > 0
      if (current === 'Error') { return; }
      const x = Number(current);
      if (!(x > 0)) { setCurrent('Error'); return; }
      current = fmt(Math.log(x));
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, `ln ${fmt(x)}`);
    }

    function applyLog10() {
      // Base-10 log. Domain: x > 0
      if (current === 'Error') { return; }
      const x = Number(current);
      if (!(x > 0)) { setCurrent('Error'); return; }
      const log10 = Math.log10 ? Math.log10(x) : (Math.log(x) / Math.LN10);
      current = fmt(log10);
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, `log ${fmt(x)}`);
    }

    function applyExp() {
      // e^x
      if (current === 'Error') { return; }
      const x = Number(current);
      current = fmt(Math.exp(x));
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, `e^ ${fmt(x)}`);
    }

    function applyPow10() {
      // 10^x
      if (current === 'Error') { return; }
      const x = Number(current);
      current = fmt(Math.pow(10, x));
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, `10^ ${fmt(x)}`);
    }

    function applyCoin() {
      // Random 0/1
      if (current === 'Error') { current = '0'; }
      const r = Math.random() < 0.5 ? 0 : 1;
      current = String(r);
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, 'Coin');
    }

    function applyDice() {
      // Random integer 1..6
      if (current === 'Error') { current = '0'; }
      const r = Math.floor(Math.random() * 6) + 1;
      current = String(r);
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, 'Dice');
    }

    function applyRand() {
      // Random in [0, 1). Ensure at least one decimal place in display.
      if (current === 'Error') { current = '0'; }
      const raw = Math.random();
      let s = raw.toFixed(12);
      s = s.replace(/0+$/, '');
      if (s.endsWith('.')) s += '0';
      current = s;
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, 'Rand');
    }

    function applyEur() {
      // Convert BGN (leva) to EUR using the fixed peg: 1 EUR = 1.95583 BGN
      if (current === 'Error') { return; }
      const EUR_BGN = 1.95583;
      const bgn = Number(current);
      if (!isFinite(bgn)) { setCurrent('Error'); return; }
      current = (bgn / EUR_BGN).toFixed(calcMode === 'TRZ' ? 3 : 2);
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, `${fmt(bgn)} BGN`);
    }

    function applyBgn() {
      // Convert EUR to BGN using the fixed peg: 1 EUR = 1.95583 BGN
      if (current === 'Error') { return; }
      const EUR_BGN = 1.95583;
      const eur = Number(current);
      if (!isFinite(eur)) { setCurrent('Error'); return; }
      current = (eur * EUR_BGN).toFixed(2);
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, `${fmt(eur)} EUR`);
    }

    function applyVatAdd() {
      // Add VAT (default 20%): net -> gross
      if (current === 'Error') { return; }
      const VAT = 0.20;
      const x = Number(current);
      if (!isFinite(x)) { setCurrent('Error'); return; }
      current = (x * (1 + VAT)).toFixed(2);
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, `+VAT ${fmt(x)}`);
    }

    function applyVatSub() {
      // Remove VAT (default 20%): gross -> net
      if (current === 'Error') { return; }
      const VAT = 0.20;
      const x = Number(current);
      if (!isFinite(x)) { setCurrent('Error'); return; }
      current = (x / (1 + VAT)).toFixed(2);
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, `-VAT ${fmt(x)}`);
    }

    function applyRound(decimals) {
      // Round current value to a fixed number of decimals.
      if (current === 'Error') { return; }
      const x = Number(current);
      if (!isFinite(x)) { setCurrent('Error'); return; }

      if (decimals === 2 && calcMode === 'TRZ') {
        current = roundTrz00(String(current));
      } else {
        current = x.toFixed(decimals);
      }
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, `${decimals === 2 ? '00' : '000'} ${fmt(x)}`);
    }

    function roundTrz00(input) {
      // TRZ mode "00" rule:
      // ако третият знак след десетичната запетая е по-голям от нула,
      // вторият знак след десетичната запетая се увеличава с една единица.
      // Practically: keep 2 decimals, but if the 3rd decimal digit is non-zero, round up.

      let s = String(input ?? '').trim();
      if (!s || s === 'Error') return '0.00';

      let negative = false;
      if (s.startsWith('-')) {
        negative = true;
        s = s.slice(1);
      } else if (s.startsWith('+')) {
        s = s.slice(1);
      }

      // If scientific notation or unexpected formatting appears, fall back to numeric handling.
      if (/[eE]/.test(s)) {
        const n = Number((negative ? '-' : '') + s);
        if (!isFinite(n)) return '0.00';
        const abs = Math.abs(n);
        const fixed3 = abs.toFixed(3);
        const third = fixed3.split('.')[1]?.[2] ?? '0';
        const base2 = abs.toFixed(2);
        let value100 = BigInt(base2.replace('.', ''));
        if (third !== '0') value100 += 1n;
        if (value100 === 0n) negative = false;
        const digits = value100.toString();
        const fracOut = digits.slice(-2).padStart(2, '0');
        const intOut = digits.length > 2 ? digits.slice(0, -2) : '0';
        return (negative ? '-' : '') + intOut + '.' + fracOut;
      }

      if (s.startsWith('.')) s = '0' + s;
      const parts = s.split('.');
      let intPart = parts[0] || '0';
      let fracPart = parts[1] || '';

      // Validate digits-only format; otherwise fall back to numeric.
      if (!/^\d+$/.test(intPart) || (fracPart && !/^\d+$/.test(fracPart))) {
        const n = Number((negative ? '-' : '') + s);
        if (!isFinite(n)) return '0.00';
        return (Object.is(n, -0) ? 0 : n).toFixed(2);
      }

      // Pad to at least 3 decimals to inspect the third digit.
      const padded3 = (fracPart + '000').slice(0, 3);
      const firstTwo = padded3.slice(0, 2);
      const third = padded3[2] || '0';

      let value100 = BigInt(intPart) * 100n + BigInt(firstTwo);
      if (third !== '0') value100 += 1n;
      if (value100 === 0n) negative = false;

      const digits = value100.toString();
      const fracOut = digits.slice(-2).padStart(2, '0');
      const intOut = digits.length > 2 ? digits.slice(0, -2) : '0';
      return (negative ? '-' : '') + intOut + '.' + fracOut;
    }

    function applyNegate() {
      // Toggle the sign of the current entry (e.g., 42 -> -42, -3.5 -> 3.5)
      if (current === 'Error') { return; }
      if (current === '0') { return; }

      if (current === '-') {
        setCurrent('0');
        return;
      }

      current = current.startsWith('-') ? current.slice(1) : `-${current}`;
      // Treat as an edit so subsequent digits append naturally.
      overwrite = false;
      renderBottom();
      renderTop();
    }

    function applyTrig(kind) {
      // Trig supports DEG and RAD modes.
      // Math.* trig functions use radians.
      if (current === 'Error') { return; }
      const input = Number(current);
      let r;
      const modeSuffix = angleMode === 'DEG' ? '°' : ' rad';
      const label = !trigInverse ? kind : (kind === 'sin' ? 'sin⁻¹' : kind === 'cos' ? 'cos⁻¹' : 'tan⁻¹');

      if (!trigInverse) {
        const radians = angleMode === 'DEG' ? (input * Math.PI / 180) : input;
        switch (kind) {
          case 'sin': r = Math.sin(radians); break;
          case 'cos': r = Math.cos(radians); break;
          case 'tan': r = Math.tan(radians); break;
          default: return;
        }
      } else {
        // Inverse trig: expects a ratio input and returns an angle.
        // Output respects the current angleMode.
        let radiansOut;
        switch (kind) {
          case 'sin': radiansOut = Math.asin(input); break;
          case 'cos': radiansOut = Math.acos(input); break;
          case 'tan': radiansOut = Math.atan(input); break;
          default: return;
        }
        r = angleMode === 'DEG' ? (radiansOut * 180 / Math.PI) : radiansOut;
      }

      current = fmt(r);
      overwrite = true;
      renderBottom();
      renderTop();
      appendLogValue(current, trigInverse ? `${label} ${fmt(input)}` : `${label} ${fmt(input)}${modeSuffix}`);
    }

    function inputPi() {
      // Insert π as a numeric constant.
      // We replace the current entry (like most calculator constants).
      if (current === 'Error') { current = '0'; }
      current = fmt(Math.PI);
      overwrite = false;
      renderBottom();
      renderTop();
    }

    function toggleAngleMode() {
      setAngleMode(angleMode === 'DEG' ? 'RAD' : 'DEG');
      setCookie('calc_angle', angleMode);
    }

    function updateTrigButtons() {
      const modeLabel = angleMode === 'DEG' ? 'degrees' : 'radians';
      const trigButtons = shell.querySelectorAll('button[data-action="sin"], button[data-action="cos"], button[data-action="tan"]');

      trigButtons.forEach((btn) => {
        const action = btn.getAttribute('data-action');
        if (!action) return;

        if (!trigInverse) {
          const name = action === 'sin' ? 'Sine' : action === 'cos' ? 'Cosine' : 'Tangent';
          btn.textContent = action;
          btn.setAttribute('aria-label', `${name} (${modeLabel})`);
        } else {
          const name = action === 'sin' ? 'Arc-sine' : action === 'cos' ? 'Arc-cosine' : 'Arc-tangent';
          // Use a common calculator-style label
          btn.textContent = action === 'sin' ? 'sin⁻¹' : action === 'cos' ? 'cos⁻¹' : 'tan⁻¹';
          btn.setAttribute('aria-label', `${name} (${modeLabel})`);
        }
      });

      const invBtn = shell.querySelector('button[data-action="inv"]');
      if (invBtn) {
        invBtn.classList.toggle('accent', trigInverse);
        invBtn.setAttribute('aria-pressed', String(trigInverse));
      }

      // INV also toggles ln/log to their inverse exponent forms.
      const lnBtn = shell.querySelector('button[data-action="ln"]');
      if (lnBtn) {
        if (!trigInverse) {
          lnBtn.textContent = 'ln';
          lnBtn.setAttribute('aria-label', 'Natural logarithm');
        } else {
          lnBtn.textContent = 'e^x';
          lnBtn.setAttribute('aria-label', 'e to the power of x');
        }
      }

      const logBtn = shell.querySelector('button[data-action="log"]');
      if (logBtn) {
        if (!trigInverse) {
          logBtn.textContent = 'log';
          logBtn.setAttribute('aria-label', 'Base-10 logarithm');
        } else {
          logBtn.textContent = '10^x';
          logBtn.setAttribute('aria-label', '10 to the power of x');
        }
      }
    }

    function setAngleMode(mode) {
      angleMode = mode === 'RAD' ? 'RAD' : 'DEG';
      toggleAngle.textContent = angleMode;
      toggleAngle.setAttribute('aria-pressed', String(angleMode === 'RAD'));
      updateTrigButtons();
    }

    function toggleTrigInverse() {
      trigInverse = !trigInverse;
      updateTrigButtons();
    }

    function updateTrzKeyLabels() {
      const round2Btn = shell.querySelector('button[data-action="round-2"]');
      if (round2Btn) {
        if (calcMode === 'TRZ') {
          round2Btn.innerHTML = '00<sup>z</sup>';
        } else {
          round2Btn.textContent = '00';
        }
      }

      const eurBtn = shell.querySelector('button[data-action="eur"]');
      if (eurBtn) {
        if (calcMode === 'TRZ') {
          eurBtn.innerHTML = 'EUR<sup>z</sup>';
        } else {
          eurBtn.textContent = 'EUR';
        }
      }
    }

    function setCalcMode(mode) {
      const m = String(mode ?? '').toUpperCase();
      calcMode = (m === 'SCI' || m === 'TRZ' || m === 'STD') ? m : 'STD';

      shell.classList.toggle('show-sci', calcMode === 'SCI');
      shell.classList.toggle('show-trz', calcMode === 'TRZ');

      // Keep aria-pressed semantics for the old two-state behavior (pressed == SCI).
      toggleSci.setAttribute('aria-pressed', String(calcMode === 'SCI'));

      // Label shows the current mode.
      toggleSci.textContent = calcMode;
      toggleSci.setAttribute('aria-label', `Calculator mode: ${calcMode}. Click to switch.`);

      updateTrzKeyLabels();
      updateFooterHelpText();
    }

    function setLogVisible(visible) {
      if (!app || !toggleLog) return;
      app.classList.toggle('show-log', !!visible);
      toggleLog.setAttribute('aria-pressed', String(!!visible));
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderMarkdownToHtml(md) {
      // Minimal Markdown renderer (headings, lists, fenced code blocks, paragraphs, inline code, bold, links).
      const lines = String(md ?? '').replace(/\r\n/g, '\n').split('\n');
      const out = [];

      let inCode = false;
      let listOpen = false;
      let paraOpen = false;

      function closePara() {
        if (paraOpen) { out.push('</p>'); paraOpen = false; }
      }
      function closeList() {
        if (listOpen) { out.push('</ul>'); listOpen = false; }
      }

      function inlineFormat(text) {
        let t = escapeHtml(text);
        // Inline code
        t = t.replace(/`([^`]+?)`/g, (_m, c) => `<code>${escapeHtml(c)}</code>`);
        // Bold
        t = t.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
        // Links [text](url)
        t = t.replace(/\[([^\]]+?)\]\(([^)\s]+)\)/g, (_m, label, url) => {
          const safeUrl = escapeHtml(url);
          const safeLabel = escapeHtml(label);
          return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${safeLabel}</a>`;
        });
        return t;
      }

      for (const line of lines) {
        const fence = line.match(/^```/);
        if (fence) {
          closePara();
          closeList();
          if (!inCode) {
            inCode = true;
            out.push('<pre><code>');
          } else {
            inCode = false;
            out.push('</code></pre>');
          }
          continue;
        }

        if (inCode) {
          out.push(escapeHtml(line) + '\n');
          continue;
        }

        const trimmed = line.trim();
        if (!trimmed) {
          closePara();
          closeList();
          continue;
        }

        const h = trimmed.match(/^(#{1,3})\s+(.*)$/);
        if (h) {
          closePara();
          closeList();
          const level = h[1].length;
          out.push(`<h${level}>${inlineFormat(h[2])}</h${level}>`);
          continue;
        }

        const li = trimmed.match(/^[-*]\s+(.*)$/);
        if (li) {
          closePara();
          if (!listOpen) { out.push('<ul>'); listOpen = true; }
          out.push(`<li>${inlineFormat(li[1])}</li>`);
          continue;
        }

        closeList();
        if (!paraOpen) { out.push('<p>'); paraOpen = true; }
        out.push(inlineFormat(trimmed) + ' ');
      }

      closePara();
      closeList();
      if (inCode) out.push('</code></pre>');
      return out.join('');
    }

    let helpLoaded = false;

    async function loadHelp() {
      if (helpLoaded) return;
      if (!helpBody) return;
      try {
        const res = await fetch('/README.md', { cache: 'no-store' });
        if (!res.ok) throw new Error('fetch failed');
        const md = await res.text();
        helpBody.innerHTML = renderMarkdownToHtml(md);
        helpLoaded = true;
      } catch {
        helpBody.innerHTML = renderMarkdownToHtml(
          '# Help\n\nUnable to load **README.md**.\n\nIf you opened `index.html` directly, some browsers block reading sibling files.\n\nStart a local server in this folder and open it via http://:\n\n```\npython -m http.server\n```\n'
        );
        helpLoaded = false;
      }
    }

    function openHelp() {
      document.body.classList.add('show-help');
      if (helpModal) helpModal.setAttribute('aria-hidden', 'false');
      loadHelp();
    }

    function closeHelp() {
      document.body.classList.remove('show-help');
      if (helpModal) helpModal.setAttribute('aria-hidden', 'true');
    }

    function updateFooterHelpText() {
      if (!footerHelp) return;

      const base = 'Keyboard: 0-9 . + - * / ^  Enter=Equals, Esc=Clear, Backspace=Delete, %=Percent, Ctrl+C=Copy, Ctrl+V=Paste';
      const isSci = calcMode === 'SCI';
      if (!isSci) {
        footerHelp.textContent = `${base}  (${calcMode}: VAT, rounding, EUR/BGN via buttons)`;
        return;
      }

      const angle = angleMode === 'RAD' ? 'RAD' : 'DEG';
      footerHelp.textContent = `${base}  (SCI: s=√, i=sin, o=cos, t=tan, p=π, r=${angle === 'RAD' ? 'DEG' : 'RAD'}, e=EXP, l=ln/e^x, g=log/10^x)`;
    }

    function applyPercent() {
      if (current === 'Error') { return; }
      let curNum = Number(current);
      if (operator === '+' || operator === '-') {
        if (prev != null) curNum = (prev * curNum) / 100;
      } else if (operator === '*' || operator === '/') {
        curNum = curNum / 100;
      } else {
        curNum = curNum / 100; // no operator: simple percent of 1
      }
      current = fmt(curNum); overwrite = true; renderBottom(); renderTop();
    }

    function setPower() {
      setOperator('^');
    }

    function compute(a, b, op) {
      // Core math with error handling; returns number or 'Error'
      switch (op) {
        case '+': return a + b;
        case '-': return a - b;
        case '*': return a * b;
        case '/': return b === 0 ? NaN : a / b;
        case '^': return Math.pow(a, b);
        default: return b;
      }
    }

    // Keyboard support: map keys to actions
    const keyMap = {
      '+': () => setOperator('+'),
      '-': () => setOperator('-'),
      '*': () => setOperator('*'),
      '/': () => setOperator('/'),
      '^': () => setOperator('^'),
      '%': () => applyPercent(),
      'Enter': () => equals(),
      '=': () => equals(),
      'Escape': () => clearAll(),
      'Backspace': () => deleteBack(),
      '.': () => inputDot(),
      'e': () => inputExpMarker(),
      'E': () => inputExpMarker(),
      's': () => applySqrt(),
      'S': () => applySqrt(),
      'i': () => applyTrig('sin'),
      'I': () => applyTrig('sin'),
      'o': () => applyTrig('cos'),
      'O': () => applyTrig('cos'),
      't': () => applyTrig('tan'),
      'T': () => applyTrig('tan'),
      'p': () => inputPi(),
      'P': () => inputPi(),
      'r': () => toggleAngleMode(),
      'R': () => toggleAngleMode(),
      'l': () => (trigInverse ? applyExp() : applyLn()),
      'L': () => (trigInverse ? applyExp() : applyLn()),
      'g': () => (trigInverse ? applyPow10() : applyLog10()),
      'G': () => (trigInverse ? applyPow10() : applyLog10()),
      'n': () => applyNegate(),
      'N': () => applyNegate(),
      'F9': () => applyNegate(),
      'c': () => clearAll(),
      'C': () => clearAll(),
    };

    window.addEventListener('keydown', (e) => {
      if (document.body.classList.contains('show-help')) {
        if (e.key === 'Escape') {
          e.preventDefault();
          closeHelp();
        }
        return;
      }

      // Clipboard shortcuts (no input element exists, so handle explicitly).
      if ((e.ctrlKey || e.metaKey) && !e.altKey) {
        const k = String(e.key || '').toLowerCase();
        if (k === 'c') {
          e.preventDefault();
          copyCurrentToClipboard();
          return;
        }
        // Let the browser trigger the paste event for Ctrl/Cmd+V.
      }

      const { key } = e;
      if (key >= '0' && key <= '9') { inputDigit(key); return; }

      // If we are in exponent entry (e.g., "5e"), treat +/- as exponent sign.
      if ((key === '+' || key === '-') && maybeInputExpSign(key)) {
        e.preventDefault();
        return;
      }

      // Unary minus: allow "-" to start a negative number entry.
      if (key === '-' && inputLeadingMinus()) {
        e.preventDefault();
        return;
      }

      const handler = keyMap[key];
      if (handler) { e.preventDefault(); handler(); }
    });

    window.addEventListener('paste', (e) => {
      // Allow paste of numeric values into the calculator.
      if (document.body.classList.contains('show-help')) return;
      const text = e.clipboardData ? e.clipboardData.getData('text') : '';
      const parsed = parsePastedNumber(text);
      if (parsed == null) return;
      e.preventDefault();

      prev = null;
      operator = null;
      overwrite = false;
      lineTop.textContent = '';
      setCurrent(parsed);
    });

    function parsePastedNumber(text) {
      let s = String(text ?? '').trim();
      if (!s) return null;

      // Common clipboard formats: allow spaces as thousand separators and comma as decimal.
      s = s.replace(/\s+/g, '');
      if (s.includes(',') && !s.includes('.')) s = s.replace(',', '.');

      // Accept: -12, 3.14, .5, 5., 1e3, 1e-3, 1.0e+10, 2e5, -10e-12
      const m = s.match(/^([+\-]?)(?:(\d+(?:\.\d*)?)|(\.\d+))(?:[eE]([+\-]?)(\d+))?$/);
      if (!m) return null;

      const sign = m[1] === '-' ? '-' : '';
      let mantissa = m[2] ? m[2] : m[3];
      if (!mantissa) return null;
      if (mantissa.startsWith('.')) mantissa = '0' + mantissa;

      const expSign = m[4] ?? '';
      const expDigits = m[5] ?? '';

      const normalized = sign + mantissa + (expDigits ? ('e' + expSign + expDigits) : '');

      const n = Number(normalized);
      if (!isFinite(n)) return null;
      // Preserve exponent form if user pasted one; otherwise keep plain number text.
      return normalized;
    }

    async function copyCurrentToClipboard() {
      if (current === 'Error') return;
      const text = String(current ?? '0');

      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(text);
          return;
        }
      } catch {
        // fall back below
      }

      // Fallback: execCommand copy.
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly', '');
        ta.style.position = 'fixed';
        ta.style.opacity = '0';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
      } catch {
        // ignore
      }
    }

    // Button interactions
    pad.addEventListener('click', (e) => {
      const b = e.target.closest('button.key');
      if (!b) return;
      const digit = b.getAttribute('data-digit');
      const op = b.getAttribute('data-op');
      const dot = b.hasAttribute('data-dot');
      const action = b.getAttribute('data-action');

      if (digit) { inputDigit(digit); return; }
      if (dot) { inputDot(); return; }
      if (op) {
        // Allow + / - buttons to act as exponent sign when entering scientific notation.
        if ((op === '+' || op === '-') && maybeInputExpSign(op)) return;

        // Unary minus via on-screen "−" key when starting an entry.
        if (op === '-' && inputLeadingMinus()) return;

        setOperator(op);
        return;
      }

      switch (action) {
        case 'clear': clearAll(); break;
        case 'del': deleteBack(); break;
        case 'equals': equals(); break;
        case 'sqrt': applySqrt(); break;
        case 'sin': applyTrig('sin'); break;
        case 'cos': applyTrig('cos'); break;
        case 'tan': applyTrig('tan'); break;
        case 'pi': inputPi(); break;
        case 'inv': toggleTrigInverse(); break;
        case 'ln': trigInverse ? applyExp() : applyLn(); break;
        case 'log': trigInverse ? applyPow10() : applyLog10(); break;
        case 'expmark': inputExpMarker(); break;
        case 'coin': applyCoin(); break;
        case 'dice': applyDice(); break;
        case 'rand': applyRand(); break;
        case 'eur': applyEur(); break;
        case 'bgn': applyBgn(); break;
        case 'vat-add': applyVatAdd(); break;
        case 'vat-sub': applyVatSub(); break;
        case 'round-2': applyRound(2); break;
        case 'round-3': applyRound(3); break;
        case 'negate': applyNegate(); break;
        case 'percent': applyPercent(); break;
        case 'power': setPower(); break;
        case 'power-inline': setPower(); break;
        default: break;
      }
    });

    if (logList) {
      logList.addEventListener('dblclick', (e) => {
        const item = e.target.closest('.log-item');
        if (!item) return;
        const value = item.getAttribute('data-value');
        if (value) copyLogValueToDisplay(value);
      });
    }

    if (logExport) {
      logExport.addEventListener('click', () => exportLogCsv());
    }

    if (logClear) {
      logClear.addEventListener('click', () => clearLog());
    }

    // Toggle log panel visibility (persistent)
    if (toggleLog) {
      toggleLog.addEventListener('click', () => {
        const next = !(app && app.classList.contains('show-log'));
        setLogVisible(next);
        setCookie('calc_log', next ? '1' : '0');
      });
      toggleLog.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleLog.click(); }
      });
    }

    // Help modal
    if (toggleHelp) {
      toggleHelp.addEventListener('click', () => openHelp());
      toggleHelp.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleHelp.click(); }
      });
    }

    if (helpClose) {
      helpClose.addEventListener('click', () => closeHelp());
    }

    if (helpModal) {
      helpModal.addEventListener('click', (e) => {
        if (e.target === helpModal) closeHelp();
      });
    }

    // Toggle calculator mode (STD -> TRZ -> SCI -> STD)
    toggleSci.addEventListener('click', () => {
      const next = calcMode === 'STD' ? 'TRZ' : (calcMode === 'TRZ' ? 'SCI' : 'STD');
      setCalcMode(next);
      setCookie('calc_mode', calcMode);
      // Backward-compatible cookie for older versions.
      setCookie('calc_sci', calcMode === 'SCI' ? '1' : '0');
    });
    toggleSci.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleSci.click(); }
    });

    toggleAngle.addEventListener('click', () => {
      toggleAngleMode();
    });
    toggleAngle.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleAngle.click(); }
    });

    // Initial render
    // Restore last used modes (if present)
    const savedAngle = getCookie('calc_angle');
    const savedMode = getCookie('calc_mode');
    const savedSci = getCookie('calc_sci');
    const savedLog = getCookie('calc_log');
    setAngleMode(savedAngle === 'RAD' ? 'RAD' : 'DEG');
    if (savedMode) {
      setCalcMode(savedMode);
    } else {
      setCalcMode(savedSci === '1' ? 'SCI' : 'STD');
    }
    setLogVisible(savedLog === '1');
    updateTrigButtons();
    updateFooterHelpText();
    loadLogEntries();
    renderTop(); renderBottom();
  </script>
</body>
</html>
